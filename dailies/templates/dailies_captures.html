<div class="DLS_CP_container">
    
    <div class="DLS_CP_title">
        <p>Captures</p>
    </div>

    <div class="DLS_CP_projects">


        <div class="DLS_PR_table">

            <table>
                <tr id="DLS_PR_table_title">
                    <th style="width:25px; border-left: none;"></th>
                    <th style="width:30px; border-left: none;"></th>
                    <th style="width:25px; border-left: none;"></th>
                    <th style="width:150px;">Project</th>
                    <th style="width:35px;">Type</th>
                    <th style="width:50px;">Studio</th>
                    <th style="width:50px;">Status</th>
                    <th style="width:75px;">Date</th>
                    <th>Comment</th>
                    <th><i class="fa-regular fa-comment"></i></th>
                    <th><i class="fa-regular fa-heart"></i></th>
                </tr>

                {% for capture in all_captures %}

                    <tr id="{{ capture.project }}" onclick="select_row(this, '{{ forloop.counter }}', '{{ capture.path_to_capture }}', '{{ capture.pk }}', '{{ capture.project.studio_name }}', '{{ capture.media_type }}')">

                        <td style="width:25px;">{{ forloop.counter }}</td>
                        <td style="width:30px;"><img src="{{ capture.path_to_thumbnail.url }}" width="25" height="25"></img></td>

                        {% if capture.comments_count > 0 %}
                            <td style="width:25px;" onclick="select_comments(event, '{{ capture }}')"><i class="fa-solid fa-comment-dots" style="color: aquamarine;"></i></td>
                        {% else %}
                            <td style="width:25px;"></td>
                        {% endif %}

                        <td style="width:150px;">{{ capture.project }}_{{ capture }}_{{ capture.version }}</td>
                        <td style="width:35px; overflow: hidden;">{{ capture.task_type }}</td>
                        <td style="width:50px;">{{ capture.project.studio_name }}</td>
                        <td style="width:50px;">{{ capture.status }}</td>
                        <td style="width:75px;">{{ capture.date_time.date|date:"d.m.y" }}</td>
                        <td>{{ capture.description }}</td>

                        {% if capture.comments_count > 0 %}
                            <td style="color: greenyellow;">{{ capture.comments_count }}</td>
                        {% else %}
                            <td>{{ capture.comments_count }}</td>
                        {% endif %}

                        {% if capture.upvotes > 0 %}
                            <td style="color: greenyellow;">{{ capture.upvotes }}</td>
                        {% else %}
                            <td>{{ capture.upvotes }}</td>
                        {% endif %}



                    </tr>

                {% endfor %}
    
              </table>




        </div>
    



    </div>



</div>




<script>

var user_ip = "{{ user_ip }}";


function select_comments(event, capture){

    event.stopPropagation(); // Stops from activating the row click.
    document.getElementById("DLS_VW_viewer").style.display = "none";
    document.getElementById("DLS_VW_comments").style.display = "block";
}


var row_selected = '';

function select_row(element, row, path, index, project_name, media_type) {

    row_selected = index;

    var mediaPrefix = "/media/";
    var file_path = mediaPrefix + path;

    if (media_type === "Video") {

        document.getElementById("DLS_VW_cap_img").style.display = "none";
        document.getElementById("DLS_VW_cap").style.display = "block";
        var videoElement = document.getElementById('DLS_VW_cap');
        videoElement.src = file_path;
        videoElement.load();
        videoElement.play();

    } else if (media_type === "Image"){

        document.getElementById("DLS_VW_cap_img").style.display = "block";
        document.getElementById("DLS_VW_cap").style.display = "none";
        var imageElement = document.getElementById('DLS_VW_cap_img');
        imageElement.src = file_path;

    } else {

        document.getElementById("DLS_VW_cap_img").style.display = "none";
        document.getElementById("DLS_VW_cap").style.display = "block";
        var videoElement = document.getElementById('DLS_VW_cap');
        videoElement.src = file_path;
        videoElement.load();
        videoElement.play();
    }

    document.getElementById("DLS_VW_comments").innerHTML = "";
    append_file_list_to_user(index, project_name)
}



function append_file_list_to_user(id, project_name){

    var xhttp = new XMLHttpRequest();

    xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            var data = JSON.parse(this.responseText);

            var selectedFile = JSON.parse(data.captures)[0].fields;
            var studio = JSON.parse(data.studio)[0].fields;
            var commento = JSON.parse(data.comments);

            var softwareContainer = document.getElementById("DLS_VW_software_container");
            softwareContainer.innerHTML = "";

            var software_used = selectedFile.software_used

            // Add software used.
            if (Boolean(software_used) === true) {
                var software_used_array = JSON.parse(software_used.replace(/'/g, "\""));

                var add_img = "";
                for (var i = 0; i < software_used_array.length; i++) {            
                    add_img += '<img class="software_item" src="/media/dailies/' + software_used_array[i] + '.png" width="20" height="20"></img>'
                }
                softwareContainer.innerHTML = add_img;
            }

            var logoContainer = document.getElementById("DLS_VW_logo_container");
            logoContainer.innerHTML = '<img class="software_item" src="/media/dailies/'+ studio.studio_name +'.png" width="20" height="20"></img>';
            

            document.getElementById("vw_d_title").innerHTML = "<span style='margin-right: 5px;'>" + studio.project_name + "</span> - <span style='margin-left: 5px;'>" + selectedFile.capture_name + "_" + selectedFile.task_type + "_" + selectedFile.version + "</span>";

            document.getElementById("vw_d_project").innerHTML = '<i class="fa-solid fa-caret-right" style="color:white; margin-right:10px;"></i>' + studio.project_name;
            document.getElementById("vw_d_studio").innerHTML = '<i class="fa-solid fa-house-user fa-2xs" style="color:white; margin-right:5px;"></i>' + studio.studio_name;
            document.getElementById("vw_d_task").innerHTML = '<i class="fa-solid fa-wrench fa-2xs" style="color:white; margin-right:10px;"></i> ' + selectedFile.task_type;
            document.getElementById("vw_d_satus").innerHTML = '<i class="fa-regular fa-flag fa-2xs" style="color:white; margin-right:10px;"></i>' + selectedFile.status;
            document.getElementById("vw_d_description").innerHTML = selectedFile.description;

            document.getElementById("DLS_VW_vote_count").innerHTML = selectedFile.upvotes;
            
            document.getElementById("DLS_VW_inp_daily").value = id; // update hidden input for write comment.

            document.getElementById("DLS_VW_viewer").style.display = "block";

            if (commento.length < 1){
                document.getElementById("DLS_comments_titles").style.display = "none";
                document.getElementById("DLS_VW_comments").style.display = "none";
            } else {

                document.getElementById("DLS_comments_titles").style.display = "block";
                document.getElementById("DLS_VW_comments").style.display = "block";

                // Add comments.
                for (var i = 0; i < commento.length; i++) {
                    var pk = commento[i].pk;
                    var comment = commento[i].fields;
                    var comment_ip = comment.user_ip

            // row
                    var DLS_VW_description = document.createElement('div');
                    DLS_VW_description.setAttribute('class', 'DLS_VW_user_comment');
                    DLS_VW_description.setAttribute('id', '');
                    document.getElementById('DLS_VW_comments').appendChild(DLS_VW_description);

            // column 01
                    var DLS_VW_desc_column_01 = document.createElement('div');
                    DLS_VW_desc_column_01.setAttribute('class', 'DLS_VW_user_comment_col_01');
                    DLS_VW_description.appendChild(DLS_VW_desc_column_01);   
                    DLS_VW_desc_column_01.innerHTML = '<i class="fa-regular fa-comment"></i>';


            // column 02
                    var DLS_VW_desc_column_02 = document.createElement('div');
                    DLS_VW_desc_column_02.setAttribute('class', 'DLS_VW_user_comment_col_02');
                    DLS_VW_description.appendChild(DLS_VW_desc_column_02);

            // comment div
                    var DLS_VW_comment = document.createElement('div');
                    DLS_VW_comment.setAttribute('class', 'DLS_VW_usr_comment');
                    DLS_VW_desc_column_02.appendChild(DLS_VW_comment);

            // p tag
                    var p_tag = document.createElement('p');

                    p_tag.innerHTML = comment.comment;
                    p_tag.setAttribute('class', 'comment');

                    var parentContainer = document.getElementById('DLS_VW_usr_comment');
                    DLS_VW_comment.appendChild(p_tag);

                    // If user created comment, then highlight it and allow user to remove it.
                    if (user_ip === comment_ip){
                        p_tag.style.color = "rgb(205, 253, 255)";
                        var comment_id = "toRemove_id_" + pk;
                        DLS_VW_description.setAttribute("id", sss)
                        DLS_VW_desc_column_01.innerHTML = '<i onmouseover="delete_icon(this, true)" onmouseout="delete_icon(this, false)" onclick="delete_comment(this, ' + pk + ', ' + comment_id + ')" id="user_comment" class="fa-regular fa-user"></i>';
                    }
                }
            }

        }
    }
    xhttp.open("GET", "/ajax_capture_data/?id=" + id, true);
    xhttp.send();
}



function delete_icon(icon, isHovering) {

  if (isHovering) {
    icon.classList.replace('fa-user', 'fa-x');
  } else {
    icon.classList.replace('fa-x', 'fa-user');
  }
}

function delete_comment(element, pk, comment_id){

    var xhttp = new XMLHttpRequest();

    xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            var data = JSON.parse(this.responseText);
            comment_id.style.display = "none";
        }
    }
    xhttp.open("GET", "/ajax_remove_comment/?id=" + pk, true);
    xhttp.send();
}


</script>




<style>



.DLS_PR_table{
    height: 50px;
    width: 100%;
    
}
.DLS_PR_table p{
    color: white;
}



.DLS_PR_table table {
    border-collapse: collapse;
    width: 100%;
    /* box-shadow: 5px 10px 5px rgb(20, 20, 20); */
    
    
}
.DLS_PR_table th {
    color: rgb(205, 253, 255);
    text-align: left;
    font-size: 13px;
    border-bottom: 1px solid rgb(50, 50, 50);
    border-left: 1px solid rgb(25, 25, 25);
    background-color: rgb(15, 15, 15);
    padding: 5px;
    font-weight:lighter;
    font-family:'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
}
.DLS_PR_table td {
    height: 40px;
    text-align: left;
    font-size: 12px;
    border-bottom: 1px solid rgb(50, 50, 50);
    padding: 5px;
    font-weight:lighter;
    font-family:'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
}


.DLS_PR_table tr:hover{
    cursor: pointer;
    background-color: rgb(40, 40, 40);
}

.DLS_PR_table tr:nth-child(even){
    background-color: rgb(22, 22, 22);
}
.DLS_PR_table tr:nth-child(even):hover{
    background-color: rgb(40, 40, 40);
}





.DLS_CP_container{
    margin: auto;
    height: 95%;
    width: 100%;
}

.DLS_CP_title{
    height: 50px;
    text-align: center;
    border-bottom: 1px solid rgb(50, 50, 50);

    display: flex;
    align-items: center;
}

.DLS_CP_projects{
    margin-top: 0px;
    height: 100%;
    overflow-y: scroll;
}
.DLS_CP_projects::-webkit-scrollbar {
  width: 2px;
}
.DLS_CP_projects::-webkit-scrollbar-track {
  background-color: transparent; /* Set the background color to transparent */
}
.DLS_CP_projects::-webkit-scrollbar-thumb {
  background-color: #4e4e4e;
}
.DLS_CP_projects::-webkit-scrollbar-thumb:hover {
  background-color: rgba(0, 0, 0, 0);
} 


.DLS_CP_proj{
    float: left;
    width: 100%;
    border: 1px solid rgb(50, 50, 50);
    background-color: rgb(19, 19, 19);
    border-radius: 10px;
    margin-top: 5px;
    padding-left: 5px;

}
.DLS_CP_proj:hover{
    cursor: pointer;
    opacity: 0.8;
}
    
    
    </style>
    
    